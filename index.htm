<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>인터넷프로그래밍 3팀</title>
</head>

<body>
	<div id="map" style="width: 100%; height: 100vh"></div>
	<script
		src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=2530315e93e47fca95bcdf52cafb039d&libraries=clusterer"></script>
	<script>

		// 전국 경찰서, 지구대, 파출소 API
		const policeApiKey ="DdC8tvJbN2Nkrf6SVd9ET4iq6Jx9wZJl%2Bjkuh5LW1rt3x45SAz1DR3k4Wky0SZEAovsAWIgb%2FWV20TNVs21QQA%3D%3D"
		const policeUrl = 'https://api.odcloud.kr/api/15054711/v1/uddi:f038d752-ff35-4a22-a2c2-cf9b90de7a30?page=1&perPage=2264&serviceKey='+policeApiKey;
		
		// 카카오 내비 API - cors 문제로 웹사이트자체에서는 내비API사용을 못합니다.. 우선 대안으로 미들 서버(cors-jhs.herokuapp.com)를 개설하고 우회해서 사용했습니다.
		const naviApiKey = "652eb2f470dd8a724c80ae923ab44f6e";
		const naviUrl = "https://cors-jhs.herokuapp.com/https://apis-navi.kakaomobility.com/v1/directions?priority=RECOMMEND&car_type=1&origin=129.1049204111099%2C+35.13367784973298&destination=129.09162466048417%2C+35.11736284697083"


		// 지도 표시
		var mapContainer = document.getElementById("map"); // 지도를 표시할 div
		var mapOption = {
			center: new kakao.maps.LatLng(35.13367784973298, 129.1049204111099), // 지도의 중심좌표 - 부경대
			level: 5, // 지도의 확대 레벨
		};
		var map = new kakao.maps.Map(mapContainer, mapOption);
		var clusterer = new kakao.maps.MarkerClusterer({
			map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
			averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
			minLevel: 7, // 클러스터 할 최소 지도 레벨
		});


		// 마커 정보창 끄고 닫기 함수
		function mouseOverListener(map, marker, infoWindow) {
			return function () {
				infoWindow.open(map, marker);
			};
		}
		function mouseOutListener(infoWindow) {
			return function () {
				infoWindow.close();
			};
		}


		// 경로 그리기 함수
		function drawLinePath(r) {
			var linePath = [];
			var roads = r.routes[0].sections[0].roads;
			var cnt = 0;
			// 경로 구간 별 좌표를 반복문으로 가져와서 배열에 저장
			for (var i = 0; i < roads.length; i++) {
				for (var j = 0; j < roads[i].vertexes.length; j++)
					if (j % 2 == 0) {
						var lat = roads[i].vertexes[j + 1];
						var lng = roads[i].vertexes[j];
						linePath[cnt++] = new kakao.maps.LatLng(lat, lng);
					}
			}
			var polyline = new kakao.maps.Polyline({ // 선 그리기 옵션
				path: linePath,
				strokeWeight: 5,
				strokeColor: 'red',
				strokeOpacity: 0.7,
				strokeStyle: 'solid'
			});
			polyline.setMap(map); // 좌표에 따라 선그리기
		}


		// 카카오 내비API 호출
		fetch(naviUrl, {
			headers: {
				Authorization: "KakaoAK "+ naviApiKey
			}
		})
			.then(res => res.json())
			.then(resJson => {
				drawLinePath(resJson); // 경로 그리기
			})

		// 지도에 경찰서 표시
		fetch(policeUrl)
			.then((res) => res.json())
			.then((resJson) => {
				var markers = [];
				var centers = resJson.data;
				for (var i = 0; i < centers.length; i++) { // 경찰서 좌표 가져오기
					var lat = centers[i]["Y좌표"];
					var lng = centers[i]["X좌표"];
					var marker = new kakao.maps.Marker({
						position: new kakao.maps.LatLng(lat, lng),
						map: map,
					});

					var infoWindow = new kakao.maps.InfoWindow({
						content: centers[i]["지구대파출소"], // 정보창에 경찰서 이름 표시
					});

					// 마커 추가
					markers.push(marker);
					// 마커 이벤트리스너 등록
					kakao.maps.event.addListener(marker, "mouseover", mouseOverListener(map, marker, infoWindow));
					kakao.maps.event.addListener(marker, "mouseout", mouseOutListener(infoWindow));
				}
				clusterer.addMarkers(markers);
			});

	</script>
</body>

</html>